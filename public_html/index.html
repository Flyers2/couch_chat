
<html>
    <head>
        <title>Fast Chat</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href ="couch.css">
        <link rel="stylesheet" href="css/bootstrap-responsive.css">
        <link rel="stylesheet" href="css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    </head>
    <body>
        <div id ="welcome">
            <h2>Welcome to FastChat</h2>
            <h5>quick and easy online chats</h5>
            <image src="http://ts2.mm.bing.net/th?&id=HN.607994655766610062&w=315&h=300&c=0&pid=1.9&rs=0&p=0" id="couchPic">
            <div id ="allRooms">
                    
                </div>
            <form id ="userInfo" class="form-inline">
                
           <span id="userNameInput">
                  enter a user name: <input type ="text" id="theUser">    
                   create new room <input type ="text" id="theRoom">
                   <button type="button" id="nameInput"  class="btn btn-primary btn-xs">submit</button>
           </span>        
             <div id="chooseroom">
                 
             </div>
        </form>
        </div>
        
        
        <div id ="messageArea" class="panel panel-primary specific" >
            <div class="panel-heading">
                 <h3 class="panel-title">Panel title</h3>
        </div>

        </div>
        <div id ="inputArea" class="specific">
            <textarea class="form-control specific" id="inputChat" rows="3"></textarea>
        </div>

        <div id ="controls" class="specific">
            <button type="button" id="submit" class="btn btn-info .btn-lg specific">send</button>
        </div>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <!--<script src="js/bootstrap.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/jquery/jquery.js"></script>-->
        <script>
            var dburl = "http://localhost:5984/fast_chat",
                seeRoomsUrl=dburl+"/_design/seerooms/_view/rooms?group_level=1";
                userName = "anonymous",
                recipient='',
                updater = 0,
                message = '';
            
             $('#nameInput').click(function(){
                userName= document.getElementById('theUser').value;
                recipient= document.getElementById('theRoom').value;
                if (recipient &&userName){
                    $('#welcome').css("display","none");
                    $('.specific').css("display","inherit");
                }
                    
            });
            $('#submit').click(function() {
                message = $('#inputChat').val();
                var package = JSON.stringify(
                    {
                        userName: userName,
                        recipient: recipient,
                        message: message
                    }
                );
           
                $.ajax(
                    {
                        type: "POST",
                        url: dburl,
                        data: package,
                        contentType: "application/json",
                        success: (function() {
                            $('#inputChat').val("");
                        })

                    }
                );
            });
            function seeChats() {
                if(recipient && userName)
                {
                     // old one $.getJSON(dburl + "/_changes?since=" + updater + "&include_docs=true", function(data) {
                     $.getJSON(dburl +"/_changes?filter=roomlimit/theroom&recipient="+recipient+"&since="+updater+"&include_docs=true",function(data){
                         var scrollToBottom;
                         data.results.forEach(function(result)
                         {
                             if( $('#messageArea').scrollTop()===($('#messageArea')[0].scrollHeight)){
                                 scrollToBottom=true;
                             }
                             $('#messageArea').append("<span class ='"+result.doc.userName+"'>"+result.doc.userName + ":" + "  " + result.doc.message + "</span><br>");
                             if(result.doc.userName===userName && result.doc.userName!=='anonymous'){
                                    $('.'+result.doc.userName).css('color','red');
                                 }
                            // if(scrollToBottom){
                                 $('#messageArea').scrollTop($('#messageArea')[0].scrollHeight);
                            // }
                         });
                         updater = data.last_seq;
                     });
                 }
            }
            setInterval(seeChats, 800);
            
            function getRooms(){
                $.getJSON(seeRoomsUrl,function(data){
                    $(data.rows).each(function(index,obj){
                       roomName= obj.key;
                       $('#allRooms').append(roomName+"<br>");
                    });
                });
            }
            getRooms();
        </script>
    </body>
</html>
